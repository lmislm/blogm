---
title: day107-typescript实现promise
tags: 
- 前端
categories: 
- 技术
date:  2019-4-29
grammar_cjkRuby: true
---
### 前言
最近某个babel的项目的时候接触到了typescript，感觉这个世界还是静态语言的天下啊。赶紧学起来。当然学静态语言，单元测试也是很重要的一部分。但是这个过程看来有点漫长，慢慢来吧。本文主要是笔记，看别人怎么实现promisejs。先看看实现[promise标准][1]和比较完美的[Bluebird方案][2]。
这篇文章有点扯，只是写了一部分，并没有写完全。0.0

![](https://ws1.sinaimg.cn/large/b15ca614gy1g2jxggrh5hj20e709g74k.jpg)
<!--more-->
### 实现（部分）

#### 接口
```typescript
type HandlerOnSuccess<T, U = any> = (value: T) => U | Thenable<U>;
type HandlerOnFail<U = any> = (reason: any) => U | Thenable<U>;

interface Handler<T, U> {
  onSuccess: HandlerOnSuccess<T, U>;
  onFail: HandlerOnFail<U>;
}
```
#### 构造器等
```typescript
class PQ<T> {
  private state: States = States.PENDING
  private handlers: Handler<T, any>[] = []
  private value: T | any
  public static errors = errors
	// 构造器constructor
  public constructor(callback: (resolve: Resolve<T>, reject: Reject) => void) {
    try {
      // 回调参数this.resolve,this.reject
      callback(this.resolve, this.reject)
    } catch (error) {
      this.reject(error)
    }
  }

  private setResult = (value: T | any, state: States) => {
    const set = () => {
      if (this.state !== States.PENDING) {
        return null
      }
      if (isThenable(value)) {
        return (value as Thenable<T>).then(this.resolve, this.reject)
      }
      this.value = value
      this.state = state

      return this.executeHandlers()
    }
    setTimeout(set, 0)
  }
}
```
### 参考

[Implementing Promises In JavaScript][3]


  [1]: https://promisesaplus.com/
  [2]: http://bluebirdjs.com/docs/api-reference.html
  [3]: https://medium.freecodecamp.org/how-to-implement-promises-in-javascript-1ce2680a7f51