---
title: day34-deepClone
tags: 
- 前端
categories: 
- 技术
date:  2019-2-13
grammar_cjkRuby: true
---
## 拷贝
探究一下深拷贝，本文主要是浅拷贝、深拷贝的简单实现，并对循环引用就行一些了解。

![](https://ws1.sinaimg.cn/large/b15ca614gy1g0555oglhej20u01hcdkz.jpg)
<!--more-->

### 准备

```javascript
let data = {
  id: '1',
  segment: {
    hitinfos: {
      // 浅拷贝时rule为rule: [Object]
      rule: {
        a: 'no-placeholder',
        b: 'no-tag'
      },
      level: 4
    },
    atoms: [
      { tgt: 'you dont know', src: '你不知道' },
      { id: 1, tgt: 'what', src: '什么' }
    ]
  },
  arr: [{
    id: 1,
    arr: 'arr1'
  }],
  value_1: undefined,
  value_2: null,
  value_3: true
}
```
### 浅拷贝
+ 简单的对象浅拷贝（只遍历一层）-拷贝引用

```javascript
function cloneShadow(src) {
  let tgt = {}
  //  为什么不直接用“=”赋值
  for (let prop in src) {
    // 或者用if (Object.hasOwnProperty(prop)) {
    if (Object.prototype.hasOwnProperty.call(src, prop)) {
      tgt[prop] = src[prop]
    }
  }
  return tgt
}
let test = cloneShadow(data)
data.id = 2
console.log(test)
console.log(data)
console.log(test)
```
### 深拷贝
+ 递归对象深拷贝（遍历多层）
```javascript
function deepClone(src) {
  // 非对象
  if (src && typeof src !== 'object') {
    return src
    // throw new TypeError('Except Object, got' + (typeof src))
  }
  // 初始化
  let tgt = Array.isArray(src) ? [] : {}
  for (let prop in src) {
    if (Object.prototype.hasOwnProperty.call(src, prop)) {
      // value为null或者undefined则返回原值(typeof null === 'object')
      if (typeof src[prop] === 'object') {
          tgt[prop] = deepClone(src[prop])
        } else {
          tgt[prop] = src[prop]
      }
    }
  }
  return tgt
}
let test_1 = deepClone(data)
console.log(test_1)
console.log(data)
console.log(test_1)
```
### 拷贝循环引用
+ 拷贝循环引用（JSON方法抛异常）
```javascript
function deepCloneCircle(src) {
  if (src && src !== 'object') return src
  let tgt = Array.isArray(src) ? [] : {}
  for (let prop in src) {
    if (Object.prototype.hasOwnProperty.call(src, tgt)) {
      if (src[prop] && src[prop] === 'object') {
        tgt[prop] = deepCloneCircle(src[prop])
      } else {
        tgt[prop] = src[prop]
      }
    }
  }
  return tgt
}
let test = deepCloneCircle(data)
console.log(test)
```
### 参考：
\[1]. [JavaScript中的浅拷贝和深拷贝][1]
\[2]. [【进阶4-3期】面试题之如何实现一个深拷贝][2]

  [1]: https://segmentfault.com/a/1190000008637489
  [2]: https://juejin.im/post/5c45112e6fb9a04a027aa8fe