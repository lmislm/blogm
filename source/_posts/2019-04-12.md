---
title: day91-Promise的并发迭代
tags: 
- 前端
categories: 
- 技术
date:  2019-4-12
grammar_cjkRuby: true
---
### 前言
多任务执行。对所有Promise执行某个任务。

![](https://ws1.sinaimg.cn/large/b15ca614gy1g20ag1vta1j20dw0a9gmb.jpg)
<!--more-->
### 实现版本一
```javascript
// Promise 的并发迭代
// 不太好的方法
if (!Promise.map) {
  Promise.map = function (vals, cb) {
    // 一个等待所有map的promise的新promise
    return Promise.all(
      // 一般数组把map(..),把值数组转换成为promise数组
      vals.map(function (val) {
        // 用val异步map之后决议的新promise替换val
        return new Promise(function (resolve) {
          cb(val, resolve)
        })
      })
    )
  }
}
// 这里不能发送异步reject信号，映射的回调中(cb(..))出现同步的异常或错误
// 主Promise.map(..)返回的Promise就会拒绝
```
### 较好的方法
```javascript
// 较好的方法
let p1 = Promise.resolve(21)
let p2 = Promise.resolve(42)
let p3 = Promise.resolve('oops 404')
// 列表值加倍，即使是在Promise中
Promise.map([p1,p2,p3], function (pr, done) {
  // 保证这一条本身就是Promise
  Promise.resolve(pr)
    .then(
      // 提取值作为v
      function (v) {
        // map完成的v到新值
        done(v*2)
      },
      // 或者map到promise拒绝消息
      done
    )
})
.then(function (vals) {
  console.log(vals) // [42, 84, 'oops 404]
})
```

